<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<meta
  name="description"
  content="Design and implement your programming language and software analysis tools with mathematical rigor."
/>
<meta name="keywords" content="runtime, verification, rv, k" />
<meta name="author" content="K | Runtime Verification Inc" />
<meta name="robots" content="index, follow" />

<!--favicon icon-->
<link rel="icon" type="image/png" href="../../../../../../assets/img/favicon.ico" />

<title>
  K | Runtime Verification Inc
</title>

<!-- <base href="/k/" /> -->

<!--web fonts-->
<link
  href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css?family=Lora:400i"
  rel="stylesheet"
/>

<link
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"
  rel="stylesheet"
/>

<link href="../../../../../../assets/css/index.css" rel="stylesheet" />

<!--[if (gt IE 9) |!(IE)]><!-->
<!--<link rel="stylesheet" href="/assets/vendor/custom-nav/css/effects/fade-menu.css"/>-->
<!-- <link rel="stylesheet" href="../../../../../../assets/k/vl-nav/css/effects/slide-menu.css" /> -->
<!--<![endif]-->

  </head>

  <body>
<header
  class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"
>
  <a class="logo-link" href="../../../../../../index.html">
    <img
      class="logo-dark"
      srcset="../../../../../../assets/img/k-logo.png"
      alt="K"
      style="height: 48px;"
    />
    Semantic Framework
  </a>
  <ul class="navbar-nav ml-md-auto">
    <li class="nav-item">
      <a
        class="nav-link pl-2 pr-1 mx-1 py-3 my-n2"
        href="https://github.com/kframework/k"
        target="_blank"
        rel="noopener"
        aria-label="GitHub"
      >
        <i class="fab fa-github"></i>
      </a>
    </li>
  </ul>
  <a
    class="btn btn-rv-blue d-none d-lg-inline-block mb-3 mb-md-0 ml-md-3"
    href="../../../../../../downloads"
    >Download</a
  >
</header>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 bd-sidebar mb-3">
  <form
    role="search"
    class="bd-search d-flex align-items-center justify-content-between"
  >
    <input
      type="search"
      class="form-control"
      placeholder="Search..."
      aria-label="Search for..."
      autocomplete="false"
      id="search-box"
    />
    <button
      class="btn bd-search-docs-toggle d-md-none p-0 ml-3 collapsed"
      type="button"
      aria-label="Toggle docs navigation"
      style="font-size: 1.4rem;"
    >
      <i class="fas fa-bars"></i>
    </button>
  </form>
  <nav class="collapse bd-links" aria-label="Main navigation">
    <div class="bd-toc-item">
      <a class="bd-toc-link" href="../../../../../../">Homepage</a>
      <a class="bd-toc-link" href="../../../../../../downloads">Downloads</a>
      <a class="bd-toc-link" href="../../../../../../k-distribution/tutorial"
        >K Tutorial</a
      >
      <a class="bd-toc-link" href="../../../../../../pending-documentation/"
        >User documentation</a
      >
      <a
        class="bd-toc-link"
        href="../../../../../../k-distribution/include/kframework/builtin/"
        >Builtins</a
      >
    </div>
  </nav>
</div>

        <main
          class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 bd-content"
          role="main"
        >
          <div class="introduction markdown-preview">
            <html><head></head><body><h1 id="kool-%E2%80%94-untyped">KOOL &#x2014; Untyped</h1>
<p>Author: Grigore Ro&#x219;u (<a href="mailto:grosu@illinois.edu" target="_blank" rel="noopener">grosu@illinois.edu</a>)<br>
Organization: University of Illinois at Urbana-Champaign</p>
<p>Author: Traian Florin &#x218;erb&#x103;nu&#x21B;&#x103; (<a href="mailto:traian.serbanuta@unibuc.ro" target="_blank" rel="noopener">traian.serbanuta@unibuc.ro</a>)<br>
Organization: University of Bucharest</p>
<h2 id="abstract">Abstract</h2>
<p>This is the <strong>K</strong> semantic definition of the untyped KOOL language.  KOOL<br>
is aimed at being a pedagogical and research language that captures<br>
the essence of the object-oriented programming paradigm.  Its untyped<br>
variant discussed here is simpler than the typed one, ignoring several<br>
intricate aspects of types in the presence of objects.  A program<br>
consists of a set of class declarations.  Each class can extend at<br>
most one other class (KOOL is single-inheritance).  A class can<br>
declare a set of fields and a set of methods, all public and called<br>
the class&apos; <em>members</em>.  Specifically, KOOL includes the<br>
following features:</p>
<ul>
<li>
<p>Class declarations, where a class may or may not explicitly<br>
extend another class.  In case a class does not explicitly extend<br>
another class, then it is assumed that it extends the default top-most<br>
and empty (i.e., no members) class called <code>Object</code>.  Each class<br>
is required to declare precisely one homonymous method, called its<br>
<em>constructor</em>.  Each valid program should contain one class<br>
named <code>Main</code>, whose constructor, <code>Main()</code>, takes no<br>
arguments.  The execution of a program consists of creating an object<br>
instance of class <code>Main</code> and invoking the constructor<br>
<code>Main()</code> on it, that is, of executing <code>new Main();</code>.</p>
</li>
<li>
<p>All features of SIMPLE (see <code>examples/simple/untyped</code>),<br>
i.e., multidimensional arrays, function (here called &quot;method&quot;)<br>
abstractions with call-by-value parameter passing style and static<br>
scoping, blocks with locals, input/output, parametric exceptions, and<br>
concurrency via dynamic thread creation/termination and synchronization.<br>
The only change in the syntax of SIMPLE when imported in KOOL is the<br>
function declaration keyword, <code>function</code>, which is changed into<br>
<code>method</code>.  The exact same desugaring macros from SIMPLE are<br>
also included in KOOL.  We can think of KOOL&apos;s classes as embedding<br>
SIMPLE programs (extended with OO constructs, as discussed next).</p>
</li>
<li>
<p>Object creation using the <code>new C(e1,...,en)</code><br>
expression construct.  An object instance of class <code>C</code> is first<br>
created and then the constructor <code>C(e1,...,en)</code> is implicitly<br>
called on that object.  KOOL only allows (and requires) one<br>
constructor per class.  The class constructor can be called either<br>
implicitly during a new object creation for the class, or explicitly.<br>
The superclass constructor is <strong>not</strong> implicitly invoked when a<br>
class constructor is invoked; if you want to invoke the superclass<br>
constructor from a subclass constructor then you have to do it<br>
explicitly.</p>
</li>
<li>
<p>An expression construct <code>this</code>, which evaluates to the<br>
current object.</p>
</li>
<li>
<p>An expression construct <code>super</code>, which is used (only) in<br>
combination with member lookup (see next) to refer to a superclass<br>
field or method.</p>
</li>
<li>
<p>A member lookup expression construct <code>e.x</code>, where <code>e</code><br>
is an expression (either an expression expected to evaluate to an object<br>
or the <code>super</code> construct) and <code>x</code> is a class member name,<br>
that is, a field or a method name.</p>
</li>
<li>
<p>Expression constructs <code>e instanceOf C</code> and<br>
<code>(C) e</code>, where <code>e</code> is an expression expected<br>
to evaluate to an object and <code>C</code> a class name.  The former<br>
tells whether the class of <code>e</code> is a subclass of <code>C</code>,<br>
that is, whether <code>e</code> can be used as an instance of <code>C</code>,<br>
and the latter changes the class of <code>e</code> to <code>C</code>.  These<br>
operations always succeed: the former returns a Boolean value, while<br>
the latter changes the current class of <code>e</code> to <code>C</code><br>
regardless of whether it is safe to do so or not.  The typed version<br>
of KOOL will check the safety of casting by ensuring that the instance<br>
class of the object is a subclass of <code>C</code>.  In untyped KOOL we<br>
do not want to perform this check because we want to allow the<br>
programmer maximum of flexibility: if one always accesses only<br>
available members, then the program can execute successfully despite<br>
the potentially unsafe cast.</p>
</li>
</ul>
<p>There are some specific aspects of KOOL that need to be discussed.</p>
<p>First, KOOL is higher-order, allowing function abstractions to be<br>
treated like any other values in the language.  For example, if<br>
<code>m</code> is a method of object <code>e</code> then <code>e.m</code><br>
evaluates to the corresponding function abstraction.  The function<br>
abstraction is in fact a closure, because in addition to the method<br>
parameters and body it also encapsulates the object value (i.e., the<br>
environment of the object together with its current class&#x2014;see below)<br>
that <code>e</code> evaluates to.  This way, function abstractions can be<br>
invoked anywhere and have the capability to change the state of their<br>
object.  For example, if <code>m</code> is a method of object <code>e</code><br>
which increments a field <code>c</code> of <code>e</code> when invoked, and if<br>
<code>getm</code> is another method of <code>e</code> which simply returns<br>
<code>m</code> when invoked, then the double application<br>
<code>(e.getm())()</code> has the same effect as <code>e.m()</code>, that is,<br>
increments the counter <code>c</code> of <code>e</code>.  Note that the<br>
higher-order nature of KOOL was not originally planned; it came as a<br>
natural consequence of evaluating methods to closures and we decided<br>
to keep it.  If you do not like it then do not use it.</p>
<p>Second, since all the fields and methods are public in KOOL and since<br>
they can be redeclared in subclasses, it is not immediately clear how<br>
to lookup the member <code>x</code> when we write <code>e.x</code> and<br>
<code>e</code> is different from <code>super</code>.  We distinguish two cases,<br>
depending on whether <code>e.x</code> occurs in a method invocation<br>
context (i.e., <code>e.x(...)</code>) or in a field context.  KOOL has<br>
dynamic method dispatch, so if <code>e.x</code> is invoked as a method<br>
then <code>x</code> will be searched for starting with the instance class of<br>
the object value to which <code>e</code> evaluates.  If <code>e.x</code><br>
occurs in a non-method-invocation context then <code>x</code> will be<br>
treated as a field (although it may hold a method closure due to the<br>
higher-order nature of KOOL) and thus will be searched starting with<br>
the current class of the object value of <code>e</code> (which, because of<br>
<code>this</code> and casting, may be different from its instance class).<br>
In order to achieve the above, each object value will consist of a<br>
pair holding the current class of the object and an environment stack<br>
with one layer for each class in the object&apos;s instance class hierarchy.</p>
<p>Third, although KOOL is dynamic method dispatch, its capabilities<br>
described above are powerful enough to allow us to mimic static<br>
method dispatch.  For example, suppose that you want to invoke method<br>
<code>m()</code> statically.  Then all you need to do is to declare a<br>
local variable and bind it to <code>m</code>, for example <code>var staticm = m;</code>, and<br>
then call <code>staticm()</code>.  This works because<br>
<code>staticm</code> is first bound to the method closure that <code>m</code><br>
evaluates to, and then looked up as any local variable when invoked.<br>
We only enable the dynamic method dispatch when we have an object<br>
member on an application position, e.g., <code>m()</code>.</p>
<p>In what follows, we limit our comments to the new, KOOL-specific<br>
aspects of the language.  We refer the reader to the untyped SIMPLE<br>
language for documentation on the the remaining features, because<br>
those were all borrowed from SIMPLE.</p>
<pre class="language-k"><code><span class="token keyword">module</span> KOOL<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>SYNTAX
  <span class="token keyword">imports</span> DOMAINS<span class="token operator">-</span>SYNTAX
</code></pre>
<h2 id="syntax">Syntax</h2>
<p>The syntax of KOOL extends that of SIMPLE with object-oriented<br>
constructs.  We removed from the <strong>K</strong> annotated syntax of SIMPLE two<br>
constructs, namely the one for function declarations (because we want<br>
to call them <code>methods</code> now) and the one for function application<br>
(because application is not strict in the first argument<br>
anymore&#x2014;needs to initiate dynamic method dispatch).  The additional<br>
syntax includes:</p>
<ul>
<li>First, we need a new dedicated identifier, <code>Object</code>, for<br>
the default top-most class.</li>
<li>Second, we rename the <code>function</code> keyword of SIMPLE into <code>method</code>.</li>
<li>Third, we add syntax for class declarations together with a<br>
macro making classes which extend nothing to extend <code>Object</code>.</li>
<li>Fourth, we change the strictness attribute of application<br>
into <code>strict(2)</code>.</li>
<li>Finally, we add syntax and corresponding strictness<br>
for the KOOL object-oriented constructs.</li>
</ul>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> <span class="token keyword">Id</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;Object&quot;</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token string">&quot;Main&quot;</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Decl <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;var&quot;</span> Exps <span class="token string">&quot;;&quot;</span>
                <span class="token operator">|</span> <span class="token string">&quot;method&quot;</span> <span class="token keyword">Id</span> <span class="token string">&quot;(&quot;</span> Ids <span class="token string">&quot;)&quot;</span> Block  <span class="token comment">// called &quot;function&quot; in SIMPLE</span>
                <span class="token operator">|</span> <span class="token string">&quot;class&quot;</span> <span class="token keyword">Id</span> Block               <span class="token comment">// KOOL</span>
                <span class="token operator">|</span> <span class="token string">&quot;class&quot;</span> <span class="token keyword">Id</span> <span class="token string">&quot;extends&quot;</span> <span class="token keyword">Id</span> Block  <span class="token comment">// KOOL</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token operator">|</span> <span class="token keyword">Bool</span> <span class="token operator">|</span> <span class="token keyword">String</span> <span class="token operator">|</span> <span class="token keyword">Id</span>
               <span class="token operator">|</span> <span class="token string">&quot;this&quot;</span>                                 <span class="token comment">// KOOL</span>
               <span class="token operator">|</span> <span class="token string">&quot;super&quot;</span>                                <span class="token comment">// KOOL</span>
               <span class="token operator">|</span> <span class="token string">&quot;(&quot;</span> Exp <span class="token string">&quot;)&quot;</span>             <span class="token punctuation">[</span><span class="token class-name">bracket</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">&quot;++&quot;</span> Exp
               <span class="token operator">|</span> Exp <span class="token string">&quot;instanceOf&quot;</span> <span class="token keyword">Id</span>     <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// KOOL</span>
               <span class="token operator">|</span> <span class="token string">&quot;(&quot;</span> <span class="token keyword">Id</span> <span class="token string">&quot;)&quot;</span> Exp          <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// KOOL  cast</span>
               <span class="token operator">|</span> <span class="token string">&quot;new&quot;</span> <span class="token keyword">Id</span> <span class="token string">&quot;(&quot;</span> Exps <span class="token string">&quot;)&quot;</span>   <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// KOOL</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;.&quot;</span> <span class="token keyword">Id</span>                             <span class="token comment">// KOOL</span>
               <span class="token operator">&gt;</span> Exp <span class="token string">&quot;[&quot;</span> Exps <span class="token string">&quot;]&quot;</span>        <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">&gt;</span> Exp <span class="token string">&quot;(&quot;</span> Exps <span class="token string">&quot;)&quot;</span>        <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// was strict in SIMPLE</span>
               <span class="token operator">|</span> <span class="token string">&quot;-&quot;</span> Exp                 <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">&quot;sizeOf&quot;</span> <span class="token string">&quot;(&quot;</span> Exp <span class="token string">&quot;)&quot;</span>    <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">&quot;read&quot;</span> <span class="token string">&quot;(&quot;</span> <span class="token string">&quot;)&quot;</span>
               <span class="token operator">&gt;</span> <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">&quot;*&quot;</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;/&quot;</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;%&quot;</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">&gt;</span> <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">&quot;+&quot;</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;-&quot;</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">&gt;</span> <span class="token class-name">non-assoc</span><span class="token punctuation">:</span>
                 Exp <span class="token string">&quot;&lt;&quot;</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;&lt;=&quot;</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;&gt;&quot;</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;&gt;=&quot;</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;==&quot;</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;!=&quot;</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">&gt;</span> <span class="token string">&quot;!&quot;</span> Exp                 <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">&gt;</span> <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">&quot;&amp;&amp;&quot;</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;||&quot;</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">&gt;</span> <span class="token string">&quot;spawn&quot;</span> Block
               <span class="token operator">&gt;</span> Exp <span class="token string">&quot;=&quot;</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">right</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Ids  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span><span class="token keyword">Id</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">}</span>

  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Exp<span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">}</span>          <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">klabel</span><span class="token punctuation">(</span>exps<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Val
  <span class="token keyword">syntax</span> Vals <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Val<span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">}</span>          <span class="token punctuation">[</span><span class="token class-name">klabel</span><span class="token punctuation">(</span>exps<span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Block <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;{&quot;</span> <span class="token string">&quot;}&quot;</span>
                <span class="token operator">|</span> <span class="token string">&quot;{&quot;</span> Stmts <span class="token string">&quot;}&quot;</span>

  <span class="token keyword">syntax</span> Stmt <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Decl <span class="token operator">|</span> Block
                <span class="token operator">|</span> Exp <span class="token string">&quot;;&quot;</span>                               <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;if&quot;</span> <span class="token string">&quot;(&quot;</span> Exp <span class="token string">&quot;)&quot;</span> Block <span class="token string">&quot;else&quot;</span> Block   <span class="token punctuation">[</span><span class="token class-name">avoid</span><span class="token punctuation">,</span> <span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;if&quot;</span> <span class="token string">&quot;(&quot;</span> Exp <span class="token string">&quot;)&quot;</span> Block
                <span class="token operator">|</span> <span class="token string">&quot;while&quot;</span> <span class="token string">&quot;(&quot;</span> Exp <span class="token string">&quot;)&quot;</span> Block
            <span class="token operator">|</span> <span class="token string">&quot;for&quot;</span> <span class="token string">&quot;(&quot;</span> Stmts Exp <span class="token string">&quot;;&quot;</span> Exp <span class="token string">&quot;)&quot;</span> Block
                <span class="token operator">|</span> <span class="token string">&quot;return&quot;</span> Exp <span class="token string">&quot;;&quot;</span>                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;return&quot;</span> <span class="token string">&quot;;&quot;</span>
                <span class="token operator">|</span> <span class="token string">&quot;print&quot;</span> <span class="token string">&quot;(&quot;</span> Exps <span class="token string">&quot;)&quot;</span> <span class="token string">&quot;;&quot;</span>              <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;try&quot;</span> Block <span class="token string">&quot;catch&quot;</span> <span class="token string">&quot;(&quot;</span> <span class="token keyword">Id</span> <span class="token string">&quot;)&quot;</span> Block
                <span class="token operator">|</span> <span class="token string">&quot;throw&quot;</span> Exp <span class="token string">&quot;;&quot;</span>                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;join&quot;</span> Exp <span class="token string">&quot;;&quot;</span>                        <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;acquire&quot;</span> Exp <span class="token string">&quot;;&quot;</span>                     <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;release&quot;</span> Exp <span class="token string">&quot;;&quot;</span>                     <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;rendezvous&quot;</span> Exp <span class="token string">&quot;;&quot;</span>                  <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Stmts <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Stmt
                 <span class="token operator">|</span> Stmts Stmts                          <span class="token punctuation">[</span><span class="token class-name">right</span><span class="token punctuation">]</span>
</code></pre>
<p>Old desugaring rules, from SIMPLE</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> if <span class="token punctuation">(</span>E<span class="token punctuation">)</span> S <span class="token operator">=</span><span class="token operator">&gt;</span> if <span class="token punctuation">(</span>E<span class="token punctuation">)</span> S else <span class="token punctuation">{</span><span class="token punctuation">}</span>                                 <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> for<span class="token punctuation">(</span>Start Cond<span class="token punctuation">;</span> Step<span class="token punctuation">)</span> <span class="token punctuation">{</span>S<span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>Start while <span class="token punctuation">(</span>Cond<span class="token punctuation">)</span> <span class="token punctuation">{</span>S Step<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> var E1<span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">,</span> E2<span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">,</span> Es<span class="token punctuation">:</span><span class="token punctuation">:</span>Exps<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> var E1<span class="token punctuation">;</span> var E2<span class="token punctuation">,</span> Es<span class="token punctuation">;</span>       <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token operator">-</span>rec<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> var X<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=</span> E<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> var X<span class="token punctuation">;</span> X <span class="token operator">=</span> E<span class="token punctuation">;</span>                              <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
</code></pre>
<p>New desugaring rule</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> class C<span class="token punctuation">:</span><span class="token keyword">Id</span> S <span class="token operator">=</span><span class="token operator">&gt;</span> class C extends Object S                     <span class="token comment">// KOOL</span>

<span class="token keyword">endmodule</span>
</code></pre>
<h2 id="semantics">Semantics</h2>
<p>We first discuss the new configuration of KOOL, which extends that of<br>
SIMPLE.  Then we include the semantics of the constructs borrowed from<br>
SIMPLE unchanged; we refrain from discussing those, because they were<br>
already discussed in the <strong>K</strong> definition of SIMPLE.  Then we discuss<br>
changes to SIMPLE&apos;s semantics needed for the more general meaning of<br>
the previous SIMPLE constructs (for example for thread spawning,<br>
assignment, etc.).  Finally, we discuss in detail the<br>
semantics of the additional KOOL constructs.</p>
<pre class="language-k"><code><span class="token keyword">module</span> KOOL<span class="token operator">-</span>UNTYPED
  <span class="token keyword">imports</span> KOOL<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>SYNTAX
  <span class="token keyword">imports</span> DOMAINS
</code></pre>
<h2 id="configuration">Configuration</h2>
<p>KOOL removes one cell and adds two nested cells to the configuration<br>
of SIMPLE.  The cell which is removed is the one holding the global<br>
environment, because a KOOL program consists of a set of classes only,<br>
with no global declarations.  In fact, since informally speaking each<br>
KOOL class now includes a SIMPLE program, it is safe to say that the<br>
global variables in SIMPLE became class fields in KOOL.  Let us now<br>
discuss the new cells that are added to the configuration of SIMPLE.</p>
<ul>
<li>
<p>The cell <code>crntObj</code> holds data pertaining to the current<br>
object, that is, the object environment in which the code in cell<br>
<code>k</code> executes: <code>crntClass</code> holds the current class (which<br>
can change as methods of the current object are invoked);<br>
<code>envStack</code> holds the stack of environments as a list,<br>
each layer corresponding to one class in the objects&apos; instance class<br>
hierarchy; <code>location</code>, which is optional, holds the location in<br>
the store where the current object is or has to be located (this is<br>
useful both for method closures and for the semantics of object<br>
creation).</p>
</li>
<li>
<p>The cell <code>classes</code> holds all the declared classes, each<br>
class being held in its own <code>class</code> cell which contains a name<br>
(<code>className</code>), a parent (<code>extends</code>), and the actual<br>
member declarations (<code>declarations</code>).</p>
</li>
</ul>
<pre class="language-k"><code>  <span class="token comment">// the syntax declarations below are required because the sorts are</span>
  <span class="token comment">// referenced directly by a production and, because of the way KIL to KORE</span>
  <span class="token comment">// is implemented, the configuration syntax is not available yet</span>
  <span class="token comment">// should simply work once KIL is removed completely</span>
  <span class="token comment">// check other definitions for this hack as well</span>
  <span class="token keyword">syntax</span> EnvCell
  <span class="token keyword">syntax</span> ControlCell
  <span class="token keyword">syntax</span> EnvStackCell
  <span class="token keyword">syntax</span> CrntObjCellFragment

  <span class="token keyword">configuration</span> <span class="token operator">&lt;</span>T color<span class="token operator">=</span><span class="token string">&quot;red&quot;</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>threads color<span class="token operator">=</span><span class="token string">&quot;orange&quot;</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>thread multiplicity<span class="token operator">=</span><span class="token string">&quot;*&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;Set&quot;</span> color<span class="token operator">=</span><span class="token string">&quot;yellow&quot;</span><span class="token operator">&gt;</span>
                      <span class="token operator">&lt;</span>k color<span class="token operator">=</span><span class="token string">&quot;green&quot;</span><span class="token operator">&gt;</span> $PGM<span class="token punctuation">:</span>Stmts <span class="token operator">~</span><span class="token operator">&gt;</span> execute <span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
                    <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                      <span class="token operator">&lt;</span>control color<span class="token operator">=</span><span class="token string">&quot;cyan&quot;</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>fstack color<span class="token operator">=</span><span class="token string">&quot;blue&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">&lt;</span><span class="token operator">/</span>fstack<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>xstack color<span class="token operator">=</span><span class="token string">&quot;purple&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">&lt;</span><span class="token operator">/</span>xstack<span class="token operator">&gt;</span>
                      <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                        <span class="token operator">&lt;</span>crntObj color<span class="token operator">=</span><span class="token string">&quot;Fuchsia&quot;</span><span class="token operator">&gt;</span>  <span class="token comment">// KOOL</span>
                           <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Object <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>
                           <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span>
                           <span class="token operator">&lt;</span>location multiplicity<span class="token operator">=</span><span class="token string">&quot;?&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>K <span class="token operator">&lt;</span><span class="token operator">/</span>location<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span>
                      <span class="token operator">&lt;</span><span class="token operator">/</span>control<span class="token operator">&gt;</span>
                    <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                      <span class="token operator">&lt;</span>env color<span class="token operator">=</span><span class="token string">&quot;violet&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
                      <span class="token operator">&lt;</span>holds color<span class="token operator">=</span><span class="token string">&quot;black&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map <span class="token operator">&lt;</span><span class="token operator">/</span>holds<span class="token operator">&gt;</span>
                      <span class="token operator">&lt;</span>id color<span class="token operator">=</span><span class="token string">&quot;pink&quot;</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&lt;</span><span class="token operator">/</span>id<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>thread<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">/</span>threads<span class="token operator">&gt;</span>
                <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                  <span class="token operator">&lt;</span>store color<span class="token operator">=</span><span class="token string">&quot;white&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map <span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>busy color<span class="token operator">=</span><span class="token string">&quot;cyan&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">.</span>Set <span class="token operator">&lt;</span><span class="token operator">/</span>busy<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>terminated color<span class="token operator">=</span><span class="token string">&quot;red&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Set <span class="token operator">&lt;</span><span class="token operator">/</span>terminated<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>input color<span class="token operator">=</span><span class="token string">&quot;magenta&quot;</span> stream<span class="token operator">=</span><span class="token string">&quot;stdin&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">&lt;</span><span class="token operator">/</span>input<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>output color<span class="token operator">=</span><span class="token string">&quot;brown&quot;</span> stream<span class="token operator">=</span><span class="token string">&quot;stdout&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">&lt;</span><span class="token operator">/</span>output<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>nextLoc color<span class="token operator">=</span><span class="token string">&quot;gray&quot;</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&lt;</span><span class="token operator">/</span>nextLoc<span class="token operator">&gt;</span>
                <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                  <span class="token operator">&lt;</span>classes color<span class="token operator">=</span><span class="token string">&quot;Fuchsia&quot;</span><span class="token operator">&gt;</span>        <span class="token comment">// KOOL</span>
                     <span class="token operator">&lt;</span>classData multiplicity<span class="token operator">=</span><span class="token string">&quot;*&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;Map&quot;</span> color<span class="token operator">=</span><span class="token string">&quot;Fuchsia&quot;</span><span class="token operator">&gt;</span>
                        <span class="token comment">// the Map has as its key the first child of the cell,</span>
                        <span class="token comment">// in this case the className cell.</span>
                        <span class="token operator">&lt;</span>className color<span class="token operator">=</span><span class="token string">&quot;Fuchsia&quot;</span><span class="token operator">&gt;</span> Main <span class="token operator">&lt;</span><span class="token operator">/</span>className<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>baseClass color<span class="token operator">=</span><span class="token string">&quot;Fuchsia&quot;</span><span class="token operator">&gt;</span> Object <span class="token operator">&lt;</span><span class="token operator">/</span>baseClass<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>declarations color<span class="token operator">=</span><span class="token string">&quot;Fuchsia&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>K <span class="token operator">&lt;</span><span class="token operator">/</span>declarations<span class="token operator">&gt;</span>
                     <span class="token operator">&lt;</span><span class="token operator">/</span>classData<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">/</span>classes<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>T<span class="token operator">&gt;</span>
</code></pre>
<h2 id="unchanged-semantics-from-untyped-simple">Unchanged Semantics from untyped SIMPLE</h2>
<p>The semantics below is taken over from SIMPLE unchanged.<br>
The semantics of function declaration and invocation, including the<br>
use of the special <code>lambda</code> abstraction value, needs to change<br>
in order to account for the fact that methods are now invoked into<br>
their object&apos;s environment.  The semantics of function return actually<br>
stays unchanged.  Also, the semantics of program initialization is<br>
different: now we have to create an instance of the <code>Main</code><br>
class which also calls the constructor <code>Main()</code>, while in<br>
SIMPLE we only had to invoke the function <code>Main()</code>.<br>
Finally, the semantics of thread spawning needs to change, too: the<br>
parent thread needs to also share its object environment with the<br>
spawned thread (in addition to its local environment, like in SIMPLE).<br>
This is needed in order to be able to spawn method invokations under<br>
dynamic method dispatch; for example, <code>spawn { run(); }</code><br>
will need to look up the method <code>run()</code> in the newly created<br>
thread, operation which will most likely fail unless the child thread<br>
sees the object environment of the parent thread.  Note that the<br>
<code>spawn</code> statement of KOOL is more permissive than the threads<br>
of Java.  In fact, the latter can be implemented in terms of our<br>
<code>spawn</code>&#x2014;see the program <code>threads.kool</code> for a sketch.</p>
<p>Below is a subset of the values of SIMPLE, which are also values<br>
of KOOL.  We will add other values later in the semantics, such as<br>
object and method closures.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token operator">|</span> <span class="token keyword">Bool</span> <span class="token operator">|</span> <span class="token keyword">String</span>
               <span class="token operator">|</span> array<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span><span class="token keyword">Int</span><span class="token punctuation">)</span>
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Val
  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Vals
  <span class="token keyword">syntax</span> KResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Val
  <span class="token keyword">syntax</span> KResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Vals
</code></pre>
<p>The semantics below are taken verbatim from the untyped SIMPLE<br>
definition.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;undefined&quot;</span>  <span class="token punctuation">[</span><span class="token class-name">latex</span><span class="token punctuation">(</span>\bot<span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> var X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">=</span><span class="token operator">&gt;</span> Env<span class="token punctuation">[</span>X <span class="token operator">&lt;</span><span class="token operator">-</span> L<span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=</span><span class="token operator">&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> undefined <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>nextLoc<span class="token operator">&gt;</span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=</span><span class="token operator">&gt;</span> L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">/</span>nextLoc<span class="token operator">&gt;</span>


  <span class="token keyword">context</span> var _<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">[</span>HOLE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> var X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">[</span>N<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">=</span><span class="token operator">&gt;</span> Env<span class="token punctuation">[</span>X <span class="token operator">&lt;</span><span class="token operator">-</span> L<span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=</span><span class="token operator">&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> array<span class="token punctuation">(</span>L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span>
                          <span class="token punctuation">(</span>L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span>L <span class="token operator">+</span><span class="token keyword">Int</span> N<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> undefined <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>nextLoc<span class="token operator">&gt;</span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=</span><span class="token operator">&gt;</span> L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token operator">+</span><span class="token keyword">Int</span> N <span class="token operator">&lt;</span><span class="token operator">/</span>nextLoc<span class="token operator">&gt;</span>
    when N <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>


  <span class="token keyword">syntax</span> <span class="token keyword">Id</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;$1&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;$2&quot;</span>
  <span class="token keyword">rule</span> var X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">[</span>N1<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> N2<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">=</span><span class="token operator">&gt;</span> var X<span class="token punctuation">[</span>N1<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token punctuation">{</span>
         var $<span class="token number">1</span><span class="token operator">=</span>X<span class="token punctuation">;</span>
         for<span class="token punctuation">(</span>var $<span class="token number">2</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> $<span class="token number">2</span> <span class="token operator">&lt;=</span> N1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>$<span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           var X<span class="token punctuation">[</span>N2<span class="token punctuation">,</span>Vs<span class="token punctuation">]</span><span class="token punctuation">;</span>
           $<span class="token number">1</span><span class="token punctuation">[</span>$<span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> X<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>


  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=</span><span class="token operator">&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> L <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>  <span class="token punctuation">[</span>lookup<span class="token punctuation">]</span>


  <span class="token keyword">context</span> <span class="token operator">++</span><span class="token punctuation">(</span>HOLE <span class="token operator">=</span><span class="token operator">&gt;</span> lvalue<span class="token punctuation">(</span>HOLE<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> <span class="token operator">++</span>loc<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> I <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>I<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=</span><span class="token operator">&gt;</span> I <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>  <span class="token punctuation">[</span>increment<span class="token punctuation">]</span>


  <span class="token keyword">rule</span> I1 <span class="token operator">+</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">+</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> Str1 <span class="token operator">+</span> Str2 <span class="token operator">=</span><span class="token operator">&gt;</span> Str1 <span class="token operator">+</span><span class="token keyword">String</span> Str2
  <span class="token keyword">rule</span> I1 <span class="token operator">-</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">-</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">*</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">*</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">/</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">/</span><span class="token keyword">Int</span> I2 when I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K <span class="token number">0</span>
  <span class="token keyword">rule</span> I1 <span class="token operator">%</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">%</span><span class="token keyword">Int</span> I2 when I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K <span class="token number">0</span>
  <span class="token keyword">rule</span> <span class="token operator">-</span> I <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token keyword">Int</span> I
  <span class="token keyword">rule</span> I1 <span class="token operator">&lt;</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">&lt;</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&lt;=</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">&lt;=</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&gt;</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">&gt;</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&gt;=</span> I2 <span class="token operator">=</span><span class="token operator">&gt;</span> I1 <span class="token operator">&gt;=</span><span class="token keyword">Int</span> I2

  <span class="token keyword">rule</span> V1<span class="token punctuation">:</span>Val <span class="token operator">==</span> V2<span class="token punctuation">:</span>Val <span class="token operator">=</span><span class="token operator">&gt;</span> V1 <span class="token operator">==</span>K V2
  <span class="token keyword">rule</span> V1<span class="token punctuation">:</span>Val <span class="token operator">!=</span> V2<span class="token punctuation">:</span>Val <span class="token operator">=</span><span class="token operator">&gt;</span> V1 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K V2
  <span class="token keyword">rule</span> <span class="token operator">!</span> T <span class="token operator">=</span><span class="token operator">&gt;</span> notBool<span class="token punctuation">(</span>T<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token boolean">true</span>  <span class="token operator">&amp;&amp;</span> E <span class="token operator">=</span><span class="token operator">&gt;</span> E
  <span class="token keyword">rule</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> <span class="token boolean">true</span>  <span class="token operator">||</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> <span class="token boolean">false</span> <span class="token operator">||</span> E <span class="token operator">=</span><span class="token operator">&gt;</span> E


  <span class="token keyword">rule</span> V<span class="token punctuation">:</span>Val<span class="token punctuation">[</span>N1<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> N2<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> V<span class="token punctuation">[</span>N1<span class="token punctuation">]</span><span class="token punctuation">[</span>N2<span class="token punctuation">,</span> Vs<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">,</span> anywhere<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> array<span class="token punctuation">(</span>L<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">[</span>N<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> lookup<span class="token punctuation">(</span>L <span class="token operator">+</span><span class="token keyword">Int</span> N<span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">,</span> anywhere<span class="token punctuation">]</span>


  <span class="token keyword">rule</span> sizeOf<span class="token punctuation">(</span>array<span class="token punctuation">(</span>_<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> N
</code></pre>
<p>The semantics of function application needs to change into dynamic<br>
method dispatch invocation, which is defined shortly.  However,<br>
interestingly, the semantics of return stays unchanged.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> return<span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">~</span><span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> V <span class="token operator">~</span><span class="token operator">&gt;</span> K <span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>control<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>fstack<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>fstackFrame<span class="token punctuation">(</span>Env<span class="token punctuation">,</span>K<span class="token punctuation">,</span>XS<span class="token punctuation">,</span><span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> CO <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>fstack<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>xstack<span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> XS <span class="token operator">&lt;</span><span class="token operator">/</span>xstack<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> CO <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span><span class="token operator">/</span>control<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>

  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;nothing&quot;</span>
  <span class="token keyword">rule</span> return<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> return nothing<span class="token punctuation">;</span>   <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>


  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> I <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>input<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>I<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>input<span class="token operator">&gt;</span>  <span class="token punctuation">[</span>read<span class="token punctuation">]</span>


  <span class="token keyword">context</span> <span class="token punctuation">(</span>HOLE <span class="token operator">=</span><span class="token operator">&gt;</span> lvalue<span class="token punctuation">(</span>HOLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> _

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> loc<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">=</span> V<span class="token punctuation">:</span>Val <span class="token operator">=</span><span class="token operator">&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">&gt;</span> V<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>
    <span class="token punctuation">[</span>assignment<span class="token punctuation">]</span>


  <span class="token keyword">rule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> <span class="token punctuation">{</span> S <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">&gt;</span> S <span class="token operator">~</span><span class="token operator">&gt;</span> setEnv<span class="token punctuation">(</span>Env<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>


  <span class="token keyword">rule</span> S1<span class="token punctuation">:</span><span class="token punctuation">:</span>Stmts S2<span class="token punctuation">:</span><span class="token punctuation">:</span>Stmts <span class="token operator">=</span><span class="token operator">&gt;</span> S1 <span class="token operator">~</span><span class="token operator">&gt;</span> S2  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> _<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>

  <span class="token keyword">rule</span> if <span class="token punctuation">(</span> <span class="token boolean">true</span><span class="token punctuation">)</span> S else _ <span class="token operator">=</span><span class="token operator">&gt;</span> S
  <span class="token keyword">rule</span> if <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> _ else S <span class="token operator">=</span><span class="token operator">&gt;</span> S

  <span class="token keyword">rule</span> while <span class="token punctuation">(</span>E<span class="token punctuation">)</span> S <span class="token operator">=</span><span class="token operator">&gt;</span> if <span class="token punctuation">(</span>E<span class="token punctuation">)</span> <span class="token punctuation">{</span>S while<span class="token punctuation">(</span>E<span class="token punctuation">)</span>S<span class="token punctuation">}</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> print<span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span> Es <span class="token operator">=</span><span class="token operator">&gt;</span> Es<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>output<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>List <span class="token operator">=</span><span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>V<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>output<span class="token operator">&gt;</span>
    <span class="token punctuation">[</span>print<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> print<span class="token punctuation">(</span><span class="token punctuation">.</span>Vals<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>


  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> xstackFrame<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">,</span>Stmt<span class="token punctuation">,</span>K<span class="token punctuation">,</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">)</span>
  <span class="token comment">// TODO(KORE): drop the additional production once parsing issue #1842 is fixed</span>
                 <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">,</span>Stmt<span class="token punctuation">,</span>K<span class="token punctuation">,</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;popx&quot;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> <span class="token punctuation">(</span>try S1 catch<span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token punctuation">{</span>S2<span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">&gt;</span> S1 <span class="token operator">~</span><span class="token operator">&gt;</span> popx<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token operator">&gt;</span> K <span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>control<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>xstack<span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">=</span><span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>xstackFrame<span class="token punctuation">(</span>X<span class="token punctuation">,</span> S2<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Env<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>xstack<span class="token operator">&gt;</span>
         C
       <span class="token operator">&lt;</span><span class="token operator">/</span>control<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> popx <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>xstack<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>xstack<span class="token operator">&gt;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> throw V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">~</span><span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> var X <span class="token operator">=</span> V<span class="token punctuation">;</span> S2 <span class="token punctuation">}</span> <span class="token operator">~</span><span class="token operator">&gt;</span> K <span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>control<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>xstack<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>xstackFrame<span class="token punctuation">(</span>X<span class="token punctuation">,</span> S2<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Env<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>xstack<span class="token operator">&gt;</span>
         <span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">&gt;</span> C<span class="token punctuation">)</span>
       <span class="token operator">&lt;</span><span class="token operator">/</span>control<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
</code></pre>
<p>Thread spawning needs a new semantics, because we want the child<br>
thread to also share the object environment with its parent.  The new<br>
semantics of thread spawning will be defined shortly.  However,<br>
interestingly, the other concurrency constructs keep their semantics<br>
from SIMPLE unchanged.</p>
<pre class="language-k"><code>  <span class="token comment">// TODO(KORE): ..Bag should be . throughout this definition #1772</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>thread<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>holds<span class="token operator">&gt;</span>H<span class="token operator">&lt;</span><span class="token operator">/</span>holds<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>id<span class="token operator">&gt;</span>T<span class="token operator">&lt;</span><span class="token operator">/</span>id<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>thread<span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Bag<span class="token punctuation">)</span>
  <span class="token comment">/*
  rule (&lt;thread&gt;... &lt;k&gt;.&lt;/k&gt; &lt;holds&gt;H&lt;/holds&gt; &lt;id&gt;T&lt;/id&gt; ...&lt;/thread&gt; =&gt; .)
  */</span>
       <span class="token operator">&lt;</span>busy<span class="token operator">&gt;</span> Busy <span class="token operator">=</span><span class="token operator">&gt;</span> Busy <span class="token operator">-</span>Set keys<span class="token punctuation">(</span>H<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>busy<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>terminated<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Set <span class="token operator">=</span><span class="token operator">&gt;</span> SetItem<span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>terminated<span class="token operator">&gt;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> join T<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>terminated<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> SetItem<span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>terminated<span class="token operator">&gt;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> acquire V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>holds<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=</span><span class="token operator">&gt;</span> V <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>holds<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>busy<span class="token operator">&gt;</span> Busy <span class="token punctuation">(</span><span class="token punctuation">.</span>Set <span class="token operator">=</span><span class="token operator">&gt;</span> SetItem<span class="token punctuation">(</span>V<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>busy<span class="token operator">&gt;</span>
    when <span class="token punctuation">(</span>notBool<span class="token punctuation">(</span>V in Busy<span class="token punctuation">:</span>Set<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span>acquire<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> acquire V<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>holds<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> V<span class="token punctuation">:</span>Val <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>N<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=</span><span class="token operator">&gt;</span> N <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>holds<span class="token operator">&gt;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> release V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>holds<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> V <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>N <span class="token operator">=</span><span class="token operator">&gt;</span> N<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">-</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>holds<span class="token operator">&gt;</span>
    when N <span class="token operator">&gt;</span><span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> release V<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>holds<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> V<span class="token punctuation">:</span>Val <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>holds<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>busy<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> SetItem<span class="token punctuation">(</span>V<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Set <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>busy<span class="token operator">&gt;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> rendezvous V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> rendezvous V<span class="token punctuation">;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>  <span class="token punctuation">[</span>rendezvous<span class="token punctuation">]</span>
</code></pre>
<h2 id="unchanged-auxiliary-operations-from-untyped-simple">Unchanged auxiliary operations from untyped SIMPLE</h2>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Stmts <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> mkDecls<span class="token punctuation">(</span>Ids<span class="token punctuation">,</span>Vals<span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> mkDecls<span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span> Xs<span class="token punctuation">:</span>Ids<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> var X<span class="token operator">=</span>V<span class="token punctuation">;</span> mkDecls<span class="token punctuation">(</span>Xs<span class="token punctuation">,</span>Vs<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> mkDecls<span class="token punctuation">(</span><span class="token punctuation">.</span>Ids<span class="token punctuation">,</span><span class="token punctuation">.</span>Vals<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// TODO(KORE): clarify sort inferences #1803</span>
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> lookup<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">)</span>
  <span class="token comment">/*
  syntax KItem ::= lookup(Int)
  */</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> lookup<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>  <span class="token punctuation">[</span>lookup<span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> setEnv<span class="token punctuation">(</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> setEnv<span class="token punctuation">(</span>Env<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>setEnv<span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token operator">&gt;</span> setEnv<span class="token punctuation">(</span>_<span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
  <span class="token comment">// TODO: How can we make sure that the second rule above applies before the first one?</span>
  <span class="token comment">//       Probably we&apos;ll deal with this using strategies, eventually.</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> lvalue<span class="token punctuation">(</span>K<span class="token punctuation">)</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> loc<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> lvalue<span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=</span><span class="token operator">&gt;</span> loc<span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
    <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

  <span class="token keyword">context</span> lvalue<span class="token punctuation">(</span>_<span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">[</span>HOLE<span class="token punctuation">:</span><span class="token punctuation">:</span>Exps<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">context</span> lvalue<span class="token punctuation">(</span>HOLE<span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">[</span>_<span class="token punctuation">:</span><span class="token punctuation">:</span>Exps<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> lvalue<span class="token punctuation">(</span>lookup<span class="token punctuation">(</span>L<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> loc<span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>


  <span class="token keyword">syntax</span> Map <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token string">&quot;...&quot;</span> <span class="token keyword">Int</span> <span class="token string">&quot;|-&gt;&quot;</span> K
    <span class="token punctuation">[</span>function<span class="token punctuation">,</span> <span class="token class-name">latex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>#<span class="token number">1</span><span class="token punctuation">}</span>\ldots<span class="token punctuation">{</span>#<span class="token number">2</span><span class="token punctuation">}</span>\mapsto<span class="token punctuation">{</span>#<span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> N<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>M <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map  when N <span class="token operator">&gt;</span><span class="token keyword">Int</span> M
  <span class="token keyword">rule</span> N<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>M <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> K <span class="token operator">=</span><span class="token operator">&gt;</span> N <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> K <span class="token punctuation">(</span>N <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>M <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> K  when N <span class="token operator">&lt;=</span><span class="token keyword">Int</span> M
</code></pre>
<h2 id="changes-to-the-existing-untyped-simple-semantics">Changes to the existing untyped SIMPLE semantics</h2>
<p>When we extend a language, sometimes we need to do more than just add<br>
new language constructs and semantics for them.  Sometimes we want to<br>
also extend the semantics of existing language constructs, in order to<br>
get more from them.</p>
<h2 id="program-initialization">Program initialization</h2>
<p>In SIMPLE, once all the global declarations were processed, the<br>
function <code>main()</code> was invoked.  In KOOL, the global<br>
declarations are classes, and their specific semantics is given<br>
shortly; essentially, they are pre-processed one by one and added<br>
into the <code>class</code> cell structure in the configuration.<br>
Once all the classes are processed, the computation item<br>
<code>execute</code>, which was placed right after the program in the<br>
initial configuration, is reached.  In SIMPLE, the program was<br>
initialized by calling the method <code>main()</code>.  In KOOL, the<br>
program is initialized by creating an object instance of class<br>
<code>Main</code>.  This will also implicitly call the method<br>
<code>Main()</code> (the <code>Main</code> class constructor).  The emptiness<br>
of the <code>env</code> cell below is just a sanity check, to make sure<br>
that the user has not declared anything but classes at the top level<br>
of the program.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;execute&quot;</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> execute <span class="token operator">=</span><span class="token operator">&gt;</span> new Main<span class="token punctuation">(</span><span class="token punctuation">.</span>Exps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
</code></pre>
<p>The semantics of <code>new</code> (defined below) requires the<br>
execution of all the class&apos; declarations (and also of its<br>
superclasses&apos;).</p>
<h2 id="object-and-method-closures">Object and method closures</h2>
<p>Before we can define the semantics of method application (previously<br>
called function application in SIMPLE), we need to add two more values<br>
to the language, namely object and method closures:</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> objectClosure<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">,</span> List<span class="token punctuation">)</span>
               <span class="token operator">|</span> methodClosure<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">,</span><span class="token keyword">Int</span><span class="token punctuation">,</span>Ids<span class="token punctuation">,</span>Stmt<span class="token punctuation">)</span>
</code></pre>
<p>An object value consists of an <code>objectClosure</code>-wrapped bag<br>
containing the current class of the object and the environment stack<br>
of the object.  The current class of an object will always be one of<br>
the classes mapped to an environment in the environment stack of the<br>
object.  A method closure encapsulates the method&apos;s parameters and<br>
code (last two arguments), as well as the object context in which the<br>
method code should execute.  This object context includes the current<br>
class of the object (the first argument of <code>methodClosure</code>) and<br>
the object environment stack (located in the object stored at the<br>
location specified as the second argument of <code>methodClosure</code>).</p>
<h2 id="method-application">Method application</h2>
<p>KOOL has a complex mechanism to invoke methods, because it allows both<br>
dynamic method dispatch and methods as first-class-citizen values (the<br>
latter making it a higher-order language).  The invocation mechanism<br>
will be defined later.  What is sufficient to know for now is that<br>
the two arguments of the application construct eventually reduce to<br>
values, the first being a method closure and the latter a list of<br>
values.  The semantics of the method closure application is then as<br>
expected: the local environment and control are stacked, then we<br>
switch to method closure&apos;s class and object environment and execute<br>
the method body.  The <code>mkDecls</code> construct is the one that came<br>
with the unchanged semantics of SIMPLE above.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> fstackFrame<span class="token punctuation">(</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">,</span>List<span class="token punctuation">,</span>K<span class="token punctuation">)</span>
  <span class="token comment">// TODO(KORE): drop the additional production once parsing issue #1842 is fixed</span>
                 <span class="token operator">|</span> <span class="token punctuation">(</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">,</span>K<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> methodClosure<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>OL<span class="token punctuation">,</span>Xs<span class="token punctuation">,</span>S<span class="token punctuation">)</span><span class="token punctuation">(</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token operator">&gt;</span> K
           <span class="token operator">=</span><span class="token operator">&gt;</span> mkDecls<span class="token punctuation">(</span>Xs<span class="token punctuation">,</span>Vs<span class="token punctuation">)</span> S return<span class="token punctuation">;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> OL <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> EnvStack<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>
     <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
       <span class="token operator">&lt;</span>control<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>xstack<span class="token operator">&gt;</span> XS <span class="token operator">&lt;</span><span class="token operator">/</span>xstack<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>fstack<span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">=</span><span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>fstackFrame<span class="token punctuation">(</span>Env<span class="token punctuation">,</span> K<span class="token punctuation">,</span> XS<span class="token punctuation">,</span> <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> Obj&apos; <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>fstack<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> Obj&apos; <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Class <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> EnvStack <span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span><span class="token operator">/</span>control<span class="token operator">&gt;</span>
</code></pre>
<h2 id="spawn">Spawn</h2>
<p>We want to extend the semantics of <code>spawn</code> to also share the<br>
current object environment with the child thread, in addition to the<br>
current environment.  This extension will allow us to also use method<br>
invocations in the spawned statements, which will be thus looked up as<br>
expected, using dynamic method dispatch.  This lookup operation would<br>
fail if the child thread did not have access to its parent&apos;s object<br>
environment.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>thread<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> spawn S <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">!</span>T<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> Obj <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>thread<span class="token operator">&gt;</span>
       <span class="token punctuation">(</span><span class="token punctuation">.</span>Bag <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span>thread<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
               <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> S <span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
               <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
               <span class="token operator">&lt;</span>id<span class="token operator">&gt;</span> <span class="token operator">!</span>T <span class="token operator">&lt;</span><span class="token operator">/</span>id<span class="token operator">&gt;</span>
               <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> Obj <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>thread<span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="semantics-of-the-new-kool-constructs">Semantics of the new KOOL constructs</h2>
<h2 id="class-declaration">Class declaration</h2>
<p>Initially, the classes forming the program are moved into their<br>
corresponding cells:</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> class Class1 extends Class2 <span class="token punctuation">{</span> S <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>classes<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Bag <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span>classData<span class="token operator">&gt;</span>
                            <span class="token operator">&lt;</span>className<span class="token operator">&gt;</span> Class1 <span class="token operator">&lt;</span><span class="token operator">/</span>className<span class="token operator">&gt;</span>
                            <span class="token operator">&lt;</span>baseClass<span class="token operator">&gt;</span> Class2 <span class="token operator">&lt;</span><span class="token operator">/</span>baseClass<span class="token operator">&gt;</span>
                            <span class="token operator">&lt;</span>declarations<span class="token operator">&gt;</span> S <span class="token operator">&lt;</span><span class="token operator">/</span>declarations<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span><span class="token operator">/</span>classData<span class="token operator">&gt;</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>classes<span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
</code></pre>
<h2 id="method-declaration">Method declaration</h2>
<p>Like in SIMPLE, method names are added to the environment and bound<br>
to their code.  However, unlike in SIMPLE where each function was<br>
executed in the same environment, namely the program global<br>
environment, a method in KOOL needs to be executed into its object&apos;s<br>
environment.  Thus, methods evaluate to closures, which encapsulate<br>
their object&apos;s context (i.e., the current class and environment stack<br>
of the object) in addition to method&apos;s parameters and body.  This<br>
approach to bind method names to method closures in the environment<br>
will also allow objects to pass their methods to other objects, to<br>
dynamically change their methods by assigning them other method<br>
closures, and even to allow all these to be done from other objects.<br>
This gives the KOOL programmer a lot of power; one should use this<br>
power wisely, though, because programs can become easily hard to<br>
understand and reason about if one overuses these features.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> method F<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">(</span>Xs<span class="token punctuation">:</span>Ids<span class="token punctuation">)</span> S <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Class<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>location<span class="token operator">&gt;</span> OL<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">&lt;</span><span class="token operator">/</span>location<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">=</span><span class="token operator">&gt;</span> Env<span class="token punctuation">[</span>F <span class="token operator">&lt;</span><span class="token operator">-</span> L<span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=</span><span class="token operator">&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> methodClosure<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>OL<span class="token punctuation">,</span>Xs<span class="token punctuation">,</span>S<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>nextLoc<span class="token operator">&gt;</span> L <span class="token operator">=</span><span class="token operator">&gt;</span> L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">/</span>nextLoc<span class="token operator">&gt;</span>
</code></pre>
<h2 id="new">New</h2>
<p>The semantics of <code>new</code> consists of two actions: memory<br>
allocation for the new object and execution of the corresponding<br>
constructor.  Then the created object is returned as the result of the<br>
<code>new</code> operation; the value returned by the constructor, if any,<br>
is discarded.  The current environment and object are stored onto the<br>
stack and recovered after new (according to the semantics of<br>
<code>return</code> borrowed from SIMPLE, when the statement<br>
<code>return this;</code> in the rule below is reached and evaluated),<br>
because the object creation part of <code>new</code> will destroy them.<br>
The rule below also initializes the object creation process by<br>
emptying the local environment and the current object, and allocating<br>
a location in the store where the created object will be eventually<br>
stored (this is what the <code>storeObj</code> task after the object<br>
creation task in the rule below will do&#x2014;its rule is defined<br>
shortly).  The location where the object will be stored is also made<br>
available in the <code>crntObj</code> cell, so that method closures can<br>
refer to it (see rule above).</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;envStackFrame&quot;</span> <span class="token string">&quot;(&quot;</span> <span class="token keyword">Id</span> <span class="token string">&quot;,&quot;</span> Map <span class="token string">&quot;)&quot;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> new Class<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">(</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token operator">&gt;</span> K
           <span class="token operator">=</span><span class="token operator">&gt;</span> create<span class="token punctuation">(</span>Class<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token operator">&gt;</span> storeObj <span class="token operator">~</span><span class="token operator">&gt;</span> Class<span class="token punctuation">(</span>Vs<span class="token punctuation">)</span><span class="token punctuation">;</span> return this<span class="token punctuation">;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>nextLoc<span class="token operator">&gt;</span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=</span><span class="token operator">&gt;</span> L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">/</span>nextLoc<span class="token operator">&gt;</span>
     <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
       <span class="token operator">&lt;</span>control<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>xstack<span class="token operator">&gt;</span> XS <span class="token operator">&lt;</span><span class="token operator">/</span>xstack<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> Obj
                   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Object <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>
                      <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span>
                      <span class="token operator">&lt;</span>location<span class="token operator">&gt;</span> L <span class="token operator">&lt;</span><span class="token operator">/</span>location<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>fstack<span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">=</span><span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>fstackFrame<span class="token punctuation">(</span>Env<span class="token punctuation">,</span> K<span class="token punctuation">,</span> XS<span class="token punctuation">,</span> <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> Obj <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>fstack<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span><span class="token operator">/</span>control<span class="token operator">&gt;</span>
</code></pre>
<p>The creation of a new object (the memory allocation part only) is<br>
a recursive process, requiring to first create an object for the<br>
superclass.  A memory object representation is a layered structure:<br>
for each class on the path from the instance class to the root of the<br>
hierarchy there is a layer including the memory allocated for the<br>
members (both fields and methods) of that class.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> create<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> create<span class="token punctuation">(</span>Class<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">)</span>
           <span class="token operator">=</span><span class="token operator">&gt;</span> create<span class="token punctuation">(</span>Class1<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token operator">&gt;</span> setCrntClass<span class="token punctuation">(</span>Class<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token operator">&gt;</span> S <span class="token operator">~</span><span class="token operator">&gt;</span> addEnvLayer <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>className<span class="token operator">&gt;</span> Class <span class="token operator">&lt;</span><span class="token operator">/</span>className<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>baseClass<span class="token operator">&gt;</span> Class1<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">&lt;</span><span class="token operator">/</span>baseClass<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>declarations<span class="token operator">&gt;</span> S <span class="token operator">&lt;</span><span class="token operator">/</span>declarations<span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> create<span class="token punctuation">(</span>Object<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
</code></pre>
<p>The next operation sets the current class of the current object.<br>
This is necessary to be done at each layer, because the current class<br>
of the object is enclosed as part of the method closures (see the<br>
semantics of method declarations above).</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> setCrntClass<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> setCrntClass<span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> C <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
</code></pre>
<p>The next operation adds a new tagged environment layer to the<br>
current object and gets ready for the next layer by clearing the<br>
environment (note that <code>create</code> expects the environment to be<br>
empty).</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;addEnvLayer&quot;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> addEnvLayer <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Map <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Class<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token operator">=</span><span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span> Env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span>
    <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
</code></pre>
<p>The following operation stores the created object at the location<br>
reserved by <code>new</code>.  Note that the location reserved by<br>
<code>new</code> was temporarily stored in the <code>crntObj</code> cell<br>
precisely for this purpose.  Now that the newly created object is<br>
stored at its location and that all method closures are aware of it,<br>
the location is unnecessary and thus we delete it from the<br>
<code>crntObj</code> cell.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;storeObj&quot;</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> storeObj <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> CC <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> ES <span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>location<span class="token operator">&gt;</span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">&lt;</span><span class="token operator">/</span>location<span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>Bag<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=</span><span class="token operator">&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> objectClosure<span class="token punctuation">(</span>CC<span class="token punctuation">,</span> ES<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>
</code></pre>
<h2 id="self-reference">Self reference</h2>
<p>The semantics of <code>this</code> is straightforward: evaluate to the<br>
current object.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> this <span class="token operator">=</span><span class="token operator">&gt;</span> objectClosure<span class="token punctuation">(</span>CC<span class="token punctuation">,</span> ES<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntObj<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> CC <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> ES <span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>crntObj<span class="token operator">&gt;</span>
</code></pre>
<h2 id="object-member-access">Object member access</h2>
<p>We can access an object member (field or method) either explicitly,<br>
using the construct <code>e.x</code>, or implicitly, using only the member<br>
name <code>x</code> directly.  The borrowed semantics of SIMPLE will<br>
already lookup a sole name in the local environment.  The first rule<br>
below reduces implicit member access to explicit access when the name<br>
cannot be found in the local environment.  There are two cases to<br>
analyze for explicit object member access, depending upon whether the<br>
object is a proper object or it is just a redirection to the parent<br>
class via the construct <code>super</code>.  In the first case, we<br>
evaluate the object expression and lookup the member starting with the<br>
current class (static scoping).  Note the use of the conditional<br>
evaluation context.  In the second case, we just lookup the member<br>
starting with the superclass of the current class.  In both cases,<br>
the <code>lookupMember</code> task eventually yields a <code>lookup(L)</code><br>
task for some appropriate location <code>L</code>, which will be further<br>
solved with the corresponding rule borrowed from SIMPLE.  Note that the<br>
current object is not altered by <code>super</code>, so future method<br>
invocations see the entire object, as needed for dynamic method dispatch.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=</span><span class="token operator">&gt;</span> this <span class="token punctuation">.</span> X <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env<span class="token punctuation">:</span>Map <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
    when notBool<span class="token punctuation">(</span>X in keys<span class="token punctuation">(</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

  <span class="token keyword">context</span> HOLE<span class="token punctuation">.</span>_<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">Id</span> when <span class="token punctuation">(</span>HOLE <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K super<span class="token punctuation">)</span>

<span class="token comment">// TODO: explain how Assoc matching has been replaced with two rules here.</span>
<span class="token comment">// Maybe also improve it a bit.</span>

<span class="token comment">/*  rule objectClosure(&lt;crntClass&gt; Class:Id &lt;/crntClass&gt;
                     &lt;envStack&gt;... envStackFrame(Class,EnvC) EStack &lt;/envStack&gt;)
       . X:Id
    =&gt; lookupMember(envStackFrame(Class,EnvC) EStack, X)
    [structural]*/</span>

  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>Class<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack<span class="token punctuation">)</span>
       <span class="token punctuation">.</span> X<span class="token punctuation">:</span><span class="token keyword">Id</span>
    <span class="token operator">=</span><span class="token operator">&gt;</span> lookupMember<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack<span class="token punctuation">,</span> X<span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>Class<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class&apos;<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List<span class="token punctuation">)</span> _<span class="token punctuation">)</span>
       <span class="token punctuation">.</span> X<span class="token punctuation">:</span><span class="token keyword">Id</span>
    when Class <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K Class&apos;  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

<span class="token comment">/*  rule &lt;k&gt; super . X =&gt; lookupMember(EStack, X) ...&lt;/k&gt;
       &lt;crntClass&gt; Class &lt;/crntClass&gt;
       &lt;envStack&gt;... envStackFrame(Class,EnvC) EStack &lt;/envStack&gt;
    [structural]*/</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> super <span class="token punctuation">.</span> X <span class="token operator">=</span><span class="token operator">&gt;</span> lookupMember<span class="token punctuation">(</span>EStack<span class="token punctuation">,</span> X<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Class<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack <span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span>
    <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> super <span class="token punctuation">.</span> X <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Class <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class&apos;<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span>
    when Class <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K Class&apos;  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
</code></pre>
<h2 id="method-invocation">Method invocation</h2>
<p>Unlike in SIMPLE, in KOOL application was declared strict only in its<br>
second argument.  That is because we want to ensure dynamic method<br>
dispatch when the first argument is a method access.  As a<br>
consequence, we need to consider all the cases of interest for the<br>
first argument and to explicitly say what to do in each case.  In all<br>
cases except for method access in a proper object (i.e., not<br>
<code>super</code>), we want the same behavior for the first argument as<br>
if it was not in a method invocation position.  When it is a member<br>
access (the third rule below), we look it up starting with the<br>
instance class of the corresponding object.  This ensures dynamic<br>
dispatch for methods; it actually dynamically dispatches field<br>
accesses, too, which is correct in KOOL, because one can assign method<br>
closures to fields and the field appeared in a method invocation<br>
context.  The last context declaration below says that method<br>
applications or array accesses are also allowed as first argument to<br>
applications; that is because methods are allowed to return methods<br>
and arrays are allowed to hold methods in KOOL, since it is<br>
higher-order.  If that is the case, then we want to evaluate the<br>
method call or the array access.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> <span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=</span><span class="token operator">&gt;</span> V<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> L <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>  <span class="token punctuation">[</span>lookup<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> <span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=</span><span class="token operator">&gt;</span> this <span class="token punctuation">.</span> X<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
    when notBool<span class="token punctuation">(</span>X in keys<span class="token punctuation">(</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

  <span class="token keyword">context</span> HOLE<span class="token punctuation">.</span>_<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> when HOLE <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K super

  <span class="token keyword">rule</span> <span class="token punctuation">(</span>objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> EStack<span class="token punctuation">)</span> <span class="token punctuation">.</span> X
    <span class="token operator">=</span><span class="token operator">&gt;</span> lookupMember<span class="token punctuation">(</span>EStack<span class="token punctuation">,</span> X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

<span class="token comment">/*  rule &lt;k&gt; (super . X
            =&gt; lookupMember(EStack,X))(_:Exps)...&lt;/k&gt;
       &lt;crntClass&gt; Class &lt;/crntClass&gt;
       &lt;envStack&gt;... envStackFrame(Class,_) EStack &lt;/envStack&gt;
    [structural]*/</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> <span class="token punctuation">(</span>super <span class="token punctuation">.</span> X
            <span class="token operator">=</span><span class="token operator">&gt;</span> lookupMember<span class="token punctuation">(</span>EStack<span class="token punctuation">,</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Class <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack <span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span>
    <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> <span class="token punctuation">(</span>super <span class="token punctuation">.</span> X<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>crntClass<span class="token operator">&gt;</span> Class <span class="token operator">&lt;</span><span class="token operator">/</span>crntClass<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>envStack<span class="token operator">&gt;</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class&apos;<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>envStack<span class="token operator">&gt;</span>
    when Class <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K Class&apos;  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

  <span class="token comment">// TODO(KORE): fix getKLabel #1801</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>A<span class="token punctuation">:</span>Exp<span class="token punctuation">(</span>B<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> A<span class="token punctuation">(</span>B<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token operator">&gt;</span> #freezerFunCall<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>A<span class="token punctuation">:</span>Exp<span class="token punctuation">[</span>B<span class="token punctuation">:</span>Exps<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> A<span class="token punctuation">[</span>B<span class="token punctuation">]</span> <span class="token operator">~</span><span class="token operator">&gt;</span> #freezerFunCall<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> V<span class="token punctuation">:</span>Val <span class="token operator">~</span><span class="token operator">&gt;</span> #freezerFunCall<span class="token punctuation">(</span>C<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> V<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#freezerFunCall&quot;</span> <span class="token string">&quot;(&quot;</span> K <span class="token string">&quot;)&quot;</span>
  <span class="token comment">/*
  context HOLE(_:Exps)
    when getKLabel(HOLE) ==K #klabel(`_(_)`) orBool getKLabel(HOLE) ==K #klabel(`_[_]`)
  */</span>
</code></pre>
<p>Eventually, each of the rules above produces a <code>lookup(L)</code><br>
task as a replacement for the method.  When that happens, we just<br>
lookup the value at location <code>L</code>:</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> <span class="token punctuation">(</span>lookup<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> V<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span> V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>
    <span class="token punctuation">[</span>lookup<span class="token punctuation">]</span>
</code></pre>
<p>The value <code>V</code> looked up above is expected to be a method closure,<br>
in which case the semantics of method application given above will<br>
apply.  Otherwise, the execution will get stuck.</p>
<h2 id="instance-of">Instance Of</h2>
<p>It searches the object environment for a layer corresponding to the<br>
desired class.  It returns <code>true</code> iff it can find the class,<br>
otherwise it returns <code>false</code>; it only gets stuck when its first<br>
argument does not evaluate to an object.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>C<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> _<span class="token punctuation">)</span>
       instanceOf C <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>

  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>C<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List<span class="token punctuation">)</span> _<span class="token punctuation">)</span>
       instanceOf C<span class="token string">&apos;  when C =/=K C&apos;</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
<span class="token comment">//TODO: remove the sort cast ::Id of C above, when sort inference bug fixed</span>

  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token punctuation">.</span>List<span class="token punctuation">)</span> instanceOf _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
</code></pre>
<h2 id="cast">Cast</h2>
<p>In untyped KOOL, we prefer to not check the validity of casting.  In<br>
other words, any cast is allowed on any object, simply changing the<br>
current class of the object to the desired class.  The execution will<br>
get stuck later if one attempts to access a field which is not<br>
available.  Moreover, the execution may complete successfully even<br>
in the presence of invalid casts, provided that each accessed member<br>
during the current execution is, or happens to be, available.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token punctuation">(</span>C<span class="token punctuation">)</span> objectClosure<span class="token punctuation">(</span>_ <span class="token punctuation">,</span> EnvStack<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> objectClosure<span class="token punctuation">(</span>C <span class="token punctuation">,</span>EnvStack<span class="token punctuation">)</span>
</code></pre>
<h2 id="kool-specific-auxiliary-declarations-and-operations">KOOL-specific auxiliary declarations and operations</h2>
<p>Here we define all the auxiliary constructs used in the above<br>
KOOL-specific semantics (those used in the SIMPLE fragment<br>
have already been defined in a corresponding section above).</p>
<h2 id="objects-as-lvalues">Objects as lvalues</h2>
<p>The current machinery borrowed with the semantics of SIMPLE allows us<br>
to enrich the set of lvalues, this way allowing new means to assign<br>
values to locations.  In KOOL, we want object member names to be<br>
lvalues, so that we can assign values to them using the already<br>
existing machinery.  The first rule below ensures that the object is<br>
always explicit, the evaluation context enforces the object to be<br>
evaluated, and finally the second rule initiates the lookup for the<br>
member&apos;s location based on the current class of the object.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token operator">&lt;</span>k<span class="token operator">&gt;</span> lvalue<span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=</span><span class="token operator">&gt;</span> this <span class="token punctuation">.</span> X<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>k<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span>env<span class="token operator">&gt;</span> Env <span class="token operator">&lt;</span><span class="token operator">/</span>env<span class="token operator">&gt;</span>
    when notBool<span class="token punctuation">(</span>X in keys<span class="token punctuation">(</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>

  <span class="token keyword">context</span> lvalue<span class="token punctuation">(</span><span class="token punctuation">(</span>HOLE <span class="token punctuation">.</span> _<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">)</span>

<span class="token comment">/*  rule lvalue(objectClosure(&lt;crntClass&gt; C &lt;/crntClass&gt;
                            &lt;envStack&gt;... envStackFrame(C,EnvC) EStack &lt;/envStack&gt;)
              . X
              =&gt; lookupMember(&lt;envStack&gt; envStackFrame(C,EnvC) EStack &lt;/envStack&gt;,
                              X))  [structural]*/</span>
  <span class="token keyword">rule</span> lvalue<span class="token punctuation">(</span>objectClosure<span class="token punctuation">(</span>Class<span class="token punctuation">,</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack<span class="token punctuation">)</span>
              <span class="token punctuation">.</span> X
              <span class="token operator">=</span><span class="token operator">&gt;</span> lookupMember<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack<span class="token punctuation">,</span>
                              X<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> lvalue<span class="token punctuation">(</span>objectClosure<span class="token punctuation">(</span>Class<span class="token punctuation">,</span> <span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class&apos;<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span>List<span class="token punctuation">)</span> _<span class="token punctuation">)</span>
              <span class="token punctuation">.</span> X<span class="token punctuation">)</span>
    when Class <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K Class&apos;  <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
</code></pre>
<h2 id="lookup-member">Lookup member</h2>
<p>It searches for the given member in the given environment stack,<br>
starting with the most concrete class and going up in the hierarchy.</p>
<pre class="language-k"><code>  <span class="token comment">// TODO(KORE): clarify sort inferences #1803</span>
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> lookupMember<span class="token punctuation">(</span>List<span class="token punctuation">,</span> <span class="token keyword">Id</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">/*
  syntax KItem ::= lookupMember(EnvStackCell,Id)  [function]
  */</span>

<span class="token comment">//  rule lookupMember(&lt;envStack&gt; envStackFrame(_, &lt;env&gt;... X|-&gt;L ...&lt;/env&gt;) ...&lt;/envStack&gt;, X)</span>
<span class="token comment">//    =&gt; lookup(L)</span>
  <span class="token keyword">rule</span> lookupMember<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>_<span class="token punctuation">,</span> X<span class="token operator">|</span><span class="token operator">-</span><span class="token operator">&gt;</span>L _<span class="token punctuation">)</span><span class="token punctuation">)</span> _<span class="token punctuation">,</span> X<span class="token punctuation">)</span>
    <span class="token operator">=</span><span class="token operator">&gt;</span> lookup<span class="token punctuation">(</span>L<span class="token punctuation">)</span>

<span class="token comment">//  rule lookupMember(&lt;envStack&gt; envStackFrame(_, &lt;env&gt; Env &lt;/env&gt;) =&gt; .List ...&lt;/envStack&gt;, X)</span>
<span class="token comment">//    when notBool(X in keys(Env))</span>
  <span class="token keyword">rule</span> lookupMember<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>_<span class="token punctuation">,</span> Env<span class="token punctuation">)</span><span class="token punctuation">)</span> Rest<span class="token punctuation">,</span> X<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
       lookupMember<span class="token punctuation">(</span>Rest<span class="token punctuation">,</span> X<span class="token punctuation">)</span>
    when notBool<span class="token punctuation">(</span>X in keys<span class="token punctuation">(</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//TODO: beautify the above</span>

<span class="token keyword">endmodule</span>
</code></pre>
<p>Go to <a href="../../../2_typed/1_dynamic/kool-typed-dynamic/">Lesson 2, KOOL typed dynamic</a>.</p>
</body></html>
          </div>
        </main>
      </div>
    </div>
<footer class="app-footer text-md-left text-center">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-2 mb-md-0 mb-4">
        <span class="pr-md-5 pr-0 py-3">
          <a href="https://runtimeverification.com" target="_blank">
            <picture>
              <source
                srcset="../../../../../../assets/img/rv-logo-dark.png"
                media="(prefers-color-scheme: dark)"
              />
              <img
                class="pr-3 footer-logo"
                src="../../../../../../assets/img/rv-logo.png"
                alt="Runtime Verification Inc logo"
              />
            </picture>
          </a>
        </span>
      </div>
      <div class="col-md-6 mb-md-0 mb-4"></div>
      <div class="col-md-4 text-md-right">
        <p class="copyright">
          &copy; 2020 Runtime Verification Inc. All right reserved.
        </p>
      </div>
    </div>
  </div>
</footer>

<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-163311512-1"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", "UA-163311512-1");
</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Typist/1.2/typist.min.js"></script>
    <script src="../../../../../../assets/js/index.js"></script>
    <script>
      $(function () {
        // Render youtube video
        const anchorElements = document.querySelectorAll(".markdown-preview a");
        for (let i = anchorElements.length - 1; i >= 0; i--) {
          if (anchorElements.length - 1 - i > 3) {
            break;
          }
          const anchorElement = anchorElements[i];
          const href = anchorElement.getAttribute("href");
          if (href.match(/^https?:\/\/youtu.be\//)) {
            const match = href.match(/^https?:\/\/youtu.be\/(.+?)$/);
            if (match && match[1]) {
              const youtubeId = match[1];
              const $iframe = $(`
<div style="text-align:center;">
  <iframe
    width="560"
    height="315"
    src="https://www.youtube.com/embed/${youtubeId}"
    frameborder="0"
    allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen
    style="max-width: 100%;"
  ></iframe>
  <p>The video is out of date</p>
</div>
`);
              $(anchorElement).replaceWith($iframe[0]);
            }
          }
        }
      });
    </script>
  </body>
</html>
